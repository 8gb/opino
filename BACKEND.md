# Opino Backend Documentation

The Opino Backend is a serverless application built with **Next.js** and **Supabase**. It handles comment storage, retrieval, site management, and authentication.

## Table of Contents
1.  [Architecture](#architecture)
2.  [Self-Hosting Guide](#self-hosting-guide)
3.  [API Reference](#api-reference)
4.  [Dashboard](#dashboard)
5.  [Troubleshooting](#troubleshooting)

## Architecture

The backend utilizes Next.js Edge Functions for low-latency API responses and Supabase for the database and authentication layer.

*   **Next.js App (`opino-app/`)**:
    *   **API Routes (`/api/*`)**: Runs on the Edge Runtime. Handles CORS validation and database interaction.
    *   **Dashboard (`/dashboard`)**: React-based admin UI for managing sites.
*   **Supabase**:
    *   **Auth**: Manages user accounts (Site Owners).
    *   **Database (PostgreSQL)**: Stores `sites` and `comments`.
    *   **Row Level Security (RLS)**: Ensures owners can only see their own sites.

## Self-Hosting Guide

You can host your own instance of Opino to have complete control over your data.

### 1. Prerequisites
*   A **Supabase** account (Free tier is sufficient).
*   A **Vercel** account (or any platform supporting Next.js Edge Functions).
*   **Cloudflare Turnstile** keys (for captcha protection).

### 2. Database Setup (Supabase)
Create a new Supabase project and run the following SQL in the SQL Editor to set up the schema:

```sql
-- 1. Create Sites Table
create table sites (
  id uuid primary key,
  uid uuid references auth.users(id),
  domain text,
  created_at timestamp with time zone default timezone('utc'::text, now())
);

-- 2. Create Comments Table
create table comments (
  id bigint generated by default as identity primary key,
  sitename uuid references sites(id),
  pathname text,
  message text,
  author text,
  parent bigint,
  uid uuid,
  timestamp bigint
);

-- 3. Enable RLS (Optional but Recommended)
alter table sites enable row level security;
alter table comments enable row level security;

-- Policy: Owners can see their own sites
create policy "Users can view own sites" on sites for select using (auth.uid() = uid);
-- Policy: Owners can insert sites (managed via Dashboard logic)
create policy "Users can insert own sites" on sites for insert with check (auth.uid() = uid);
```

### 3. Environment Variables
You need to configure these variables in your hosting provider (e.g., Vercel) or `.env.local` for local development.

| Variable | Description |
| :--- | :--- |
| `NEXT_PUBLIC_SUPABASE_URL` | Your Supabase Project URL. |
| `NEXT_PUBLIC_SUPABASE_ANON_KEY` | Your Supabase `anon` public key. |
| `SUPABASE_SERVICE_ROLE_KEY` | Your Supabase `service_role` secret key. **CRITICAL**: Used by API routes to bypass RLS. |
| `NEXT_PUBLIC_TURNSTILE_SITE_KEY` | Cloudflare Turnstile Site Key. |
| `API_DOMAIN` | (Optional) Domain for custom API routing middleware. |

### 4. Deployment (Vercel)
1.  Fork the repository.
2.  Import the `opino-app` folder as a new project in Vercel.
3.  Add the environment variables from Step 3.
4.  Deploy.

Once deployed, your API URL will be `https://your-project.vercel.app`. You will need to update the Widget's `index.js` to point to this URL.

## API Reference

The Widget communicates with these endpoints.

### GET `/api/thread`
Fetches all comments for a specific page.

*   **Query Parameters**:
    *   `siteName`: The UUID of the site.
    *   `pathName`: The slugified path of the page (e.g., `blog-post-1`).
*   **Response**: Array of comment objects.

### POST `/api/add`
Adds a new comment.

*   **Headers**:
    *   `Origin`: Must match the `domain` configured for the site in the database.
*   **Body (JSON)**:
    ```json
    {
      "siteName": "uuid-string",
      "pathName": "blog-post-1",
      "message": "Hello world!",
      "author": "User Name",
      "parent": null // or ID of parent comment for replies
    }
    ```

## Dashboard
The dashboard is located at `/dashboard` (after login).
*   **Add Site**: Generates a new Site UUID.
*   **Edit Domain**: Important! You must enter the domain (e.g., `mysite.com`) where the widget will be embedded. The API uses this to enforce CORS.

## Troubleshooting

### "Invalid Origin" Error
*   **Symptom**: `POST /api/add` fails with 400 Bad Request.
*   **Cause**: The request is coming from a domain that hasn't been whitelisted.
*   **Fix**: Go to the Dashboard and ensure your domain (e.g., `localhost:8080` or `mysite.com`) is saved in the site configuration.

### "Invalid Site" Error
*   **Symptom**: API returns "invalid site".
*   **Cause**: The `siteName` (UUID) provided in the request does not exist in the `sites` table.
*   **Fix**: Check that the `data-opino-site` attribute in your HTML matches the ID in the Dashboard exactly.
